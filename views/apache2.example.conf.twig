# ------------------------------------------
# {{ hostname }} virtual host
# Automatically generated with RZ Deployer
# on {{ datetime|date('Y/m/d H:i') }}
# ------------------------------------------
{% set main_script = 'index' %}
{% if use_symfony %}
    {% set main_script = 'app' %}
{% endif %}
{% set fpm_version = fpm_version|default('5') %}
<VirtualHost *:80>
    ServerName {{ hostname }}
    ServerAdmin {{ email }}

    {% if use_roadiz_se or use_symfony %}
        DocumentRoot {{ rootPath }}/{{ vhost_root }}/web
    {% else %}
        DocumentRoot {{ rootPath }}/{{ vhost_root }}
    {% endif %}

     # Some security
    <IfModule mod_headers.c>
        Header set X-XSS-Protection "1; mode=block"
        Header set X-Content-Type-Options "nosniff"
        Header set X-Frame-Options "SAMEORIGIN"
    </IfModule>

    {% if mpm_itk %}
    # Apache MPM ITK enables user uid and gid for current process (Apache + mod_php)
    # But it decreases performances and can be dangerous as Apache has to use *root* privilege before
    # create a child process using to right uid and gid
    <IfModule mpm_itk_module>
        AssignUserId {{ username }} {{ username }}
    </IfModule>
    {% endif %}

    # Forbid webserver root
    <Directory "/var/www">
        Options +FollowSymLinks
        AllowOverride None
        Deny from all
    </Directory>

    <Directory {{ rootPath }}/{{ vhost_root }}/>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride None
        Order allow,deny
        Allow from all

        ErrorDocument 404 /
        IndexIgnore *

        # ------------------------------------
        # EXPIRES CACHING
        # ------------------------------------
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/pdf "access plus 1 month"
            ExpiresByType text/x-javascript "access plus 1 month"
            ExpiresByType text/javascript "access plus 1 month"
            ExpiresByType application/x-shockwave-flash "access plus 1 month"
            ExpiresByType image/x-icon "access plus 1 year"
            ExpiresByType application/vnd.ms-fontobject "access plus 1 month"
            ExpiresByType application/x-font-ttf "access plus 1 month"
            ExpiresByType application/x-font-opentype "access plus 1 month"
            ExpiresByType application/x-font-woff "access plus 1 month"
            ExpiresByType image/svg+xml "access plus 1 month"
            ExpiresDefault "access plus 2 days"
        </IfModule>

        {% if use_rzcms %}
        <IfModule mod_rewrite.c>
            RewriteEngine On

            # redirect additionnal domains
            # RewriteCond %{HTTP_HOST} ^(www\.)?other_domain\.fr$ [NC]
            # RewriteRule ^(.*)$ http://{{ hostname }}/$1 [R=301,L]
            # RewriteCond %{HTTP_HOST} ^(www\.)?other_domain\.org$ [NC]
            # RewriteRule ^(.*)$ http://{{ hostname }}/$1 [R=301,L]
            # RewriteCond %{HTTP_HOST} ^(www\.)?other_domain\.org$ [NC]
            # RewriteRule ^(.*)$ http://{{ hostname }}/$1 [R=301,L]

            # Redirect to www
            #RewriteCond %{HTTP_HOST} !^www\.
            #RewriteRule ^(.*)$ http://www.%{HTTP_HOST}/$1 [R=301,L]

            # ByPass for these folders
            RewriteRule ^documents - [L,NC]
            RewriteRule ^rz-temp - [L,NC]
            RewriteRule ^templates - [L,NC]

            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^(.*)$ index.php [QSA,L]
        </IfModule>
        {% else if use_roadiz or use_index_entrypoint or use_symfony %}
        <IfModule mod_rewrite.c>
            RewriteEngine On
            # Redirect to www
            #RewriteCond %{HTTP_HOST} !^www\.
            #RewriteRule ^(.*)$ http://www.%{HTTP_HOST}/$1 [R=301,L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^(.*)$ {{ main_script }}.php/$1 [QSA,L]
        </IfModule>
        {% endif %}
    </Directory>

    {% if use_rzcms %}
    # ------- Secure RZ_CMS folders ------------------------
    <Directory {{ rootPath }}/{{ vhost_root }}/rz-core/>
        <FilesMatch ".$">
            Order deny,allow
            Deny from all
        </FilesMatch>
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/fonts/>
        <FilesMatch ".$">
            Order deny,allow
            Deny from all
        </FilesMatch>
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/private_documents/>
        <FilesMatch ".$">
            Order deny,allow
            Deny from all
        </FilesMatch>
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/cache/>
        <FilesMatch ".$">
            Order deny,allow
            Deny from all
        </FilesMatch>
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/rz-conf/>
        <FilesMatch ".$">
            Order deny,allow
            Deny from all
        </FilesMatch>
    </Directory>
    {% endif %}

    {% if use_roadiz %}
    <Directory {{ rootPath }}/{{ vhost_root }}/themes/>
        <Files ~ "^\.php|yml|twig|xlf|rzn|rzt|rzg">
          Order allow,deny
          Deny from all
        </Files>
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/src/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/gen-src/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/files/fonts/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/files/private/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/cache/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/bin/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/samples/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/tests/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/vendor/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/conf/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/build/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/logs/>
        Order deny,allow
        Deny from all
    </Directory>
    <Directory {{ rootPath }}/{{ vhost_root }}/.git/>
        Order deny,allow
        Deny from all
    </Directory>
    {% endif %}

    {% if phpfpm_enabled %}
    Alias /fcgi-bin/php5-fpm /fcgi-bin-php{{ fpm_version }}-fpm-{{ username }}
    FastCgiExternalServer /fcgi-bin-php{{ fpm_version }}-fpm-{{ username }} -socket /var/run/php{{ fpm_version }}-fpm-{{ username }}.sock -pass-header Authorization
    {% endif %}

    ErrorLog {{ rootPath }}/log/error.apache.log
    LogLevel warn
    CustomLog {{ rootPath }}/log/access.apache.log combined
</VirtualHost>