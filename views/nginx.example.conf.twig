# ------------------------------------------
# {{ hostname }} virtual host
# Automatically generated with RZ Deployer
# on {{ datetime|date('Y/m/d H:i') }}
# ------------------------------------------

# List here redirections
# server {
#     listen 80;
#     listen [::]:80;
#     server_name ### Your redirected domain: for example your domain without www ###;
#     return 301 $scheme://{{ hostname }}$request_uri;
# }

{% set fpm_version = fpm_version|default('5') %}
{% set main_script = 'index' %}
{% if use_symfony %}
    {% set main_script = 'app' %}
{% endif %}


# Main domain virtual host
server {
    listen   80; ## listen for ipv4; this line is default and implied
    listen   [::]:80; ## listen for ipv6

    {% if use_roadiz_se or use_symfony %}
        root {{ rootPath }}/{{ vhost_root }}/web;
    {% else %}
        root {{ rootPath }}/{{ vhost_root }};
    {% endif %}

    index {{ main_script }}.php index.html index.htm;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    # Make site accessible from http://{{ hostname }}/
    # If you don’t defined any subdomain, you can use "*.{{ hostname }}"
    server_name {{ hostname }};

    # Specify a character set
    charset utf-8;

    access_log {{ rootPath }}/log/access.nginx.log;
    error_log {{ rootPath }}/log/error.nginx.log;

    # Use Front-end controller pattern for RZ-CMS, Wordpress and others CMS…
    location / {
        try_files $uri $uri/ /{{ main_script }}.php?$query_string;
    }

    # Don't log robots.txt or favicon.ico files
    location = /favicon.ico { log_not_found off; access_log off; }
    location = /robots.txt  { allow all; access_log off; log_not_found off; }

    {% if use_roadiz or use_symfony %}
    location ~ /themes/(.+)\.(php|yml|twig|xlf|rzn|rzt|rzg)$ {
        deny all;
    }

    # Enable Expire on Themes public assets
    location ~* ^/(themes|bundles)/*.*\.(?:ico|css|js|woff2?|eot|ttf|otf|svg|gif|jpe?g|png)$ {
        expires 30d;
        access_log off;
        add_header Pragma "public";
        add_header Cache-Control "public";
        add_header Vary "Accept-Encoding";
    }
    # Enable Expire on native documents files
    location ~* ^/files/*.*\.(?:ico|gif|jpe?g|png)$ {
        expires 15d;
        access_log off;
        add_header Pragma "public";
        add_header Cache-Control "public";
        add_header Vary "Accept-Encoding";
    }

    location ~ /install.php/ {
        try_files $uri @pass_to_roadiz_install;
    }
    location @pass_to_roadiz_install{
        rewrite ^ /install.php?$request_uri last;
    }
    location ~ /dev.php/ {
        try_files $uri @pass_to_roadiz_dev;
    }
    location @pass_to_roadiz_dev{
        rewrite ^ /dev.php?$request_uri last;
    }
    location ~ /preview.php/ {
        try_files $uri @pass_to_roadiz_preview;
    }
    location @pass_to_roadiz_preview{
        rewrite ^ /preview.php?$request_uri last;
    }

    #
    # Production entry point.
    #
    location ~ ^/{{ main_script }}\.php(/|$) {
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
        # With php5-fpm:
        fastcgi_pass unix:/var/run/php{{ fpm_version }}-fpm-{{ username }}.sock;
        include fastcgi_params;
        # Prevents URIs that include the front controller. This will 404:
        # http://domain.tld/{{ main_script }}.php/some-path
        # Remove the internal directive to allow URIs like this
        internal;
    }

    #
    # Preview, Dev and Install entry points.
    #
    # In production server, don't deploy dev.php or install.php
    #
    location ~ ^/(dev|install|preview|clear_cache)\.php(/|$) {
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
        # With php5-fpm:
        fastcgi_pass unix:/var/run/php{{ fpm_version }}-fpm-{{ username }}.sock;
        include fastcgi_params;
    }
    {% else %}
    # pass the PHP scripts to FastCGI server
    # listening on {{ rootPath }}/php{{ fpm_version }}-fpm.sock
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php{{ fpm_version }}-fpm-{{ username }}.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param SERVER_PORT 80;
    }
    {% endif %}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    location ~ /\.ht {
        deny all;
    }

    {% if use_rzcms %}
    # Deny acces to private folders
    location /fonts {
        deny all;
    }
    location /rz-core {
        deny all;
    }
    location /private_documents {
        deny all;
    }
    location /cache {
        deny all;
    }
    location /rz-conf {
        deny all;
    }
    {% endif %}

    {% if use_roadiz %}
    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    location ~ /\.ht {
        deny all;
    }
    location ~ /\.git {
        deny all;
    }
    location /src {
        deny all;
    }
    location /gen-src {
        deny all;
    }
    location /files/fonts {
        deny all;
    }
    location /files/private {
        deny all;
    }
    location /cache {
        deny all;
    }
    location /bin {
        deny all;
    }
    location /samples {
        deny all;
    }
    location /tests {
        deny all;
    }
    location /vendor {
        deny all;
    }
    location /conf {
        deny all;
    }
    location /logs {
        deny all;
    }
    {% endif %}

    {% if phpmyadmin_install %}
    # PHPMYADMIN
    location /phpmyadmin {
       root /usr/share/;
       index index.php index.html index.htm;

       location ~ ^/phpmyadmin/(.+\.php)$ {
            try_files $uri =404;
            root /usr/share/;
            # Use default pool
            fastcgi_pass unix:/var/run/php{{ fpm_version }}-fpm.sock;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
       }
       location ~* ^/phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
               root /usr/share/;
       }
    }
    location /phpMyAdmin {
           rewrite ^/* /phpmyadmin last;
    }
    {% endif %}
}
